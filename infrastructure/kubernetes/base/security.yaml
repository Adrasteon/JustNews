# Network Policies for JustNews Security

# Allow database access only from agents
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-db-access
  namespace: justnews
spec:
  podSelector:
    matchLabels:
      component: database
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          component: agent
    ports:
    - protocol: TCP
      port: 5432  # PostgreSQL
    - protocol: TCP
      port: 6379  # Redis

---
# Allow MCP Bus communication from all agents
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-mcp-bus-access
  namespace: justnews
spec:
  podSelector:
    matchLabels:
      app: mcp-bus
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          component: agent
    - podSelector:
        matchLabels:
          component: monitoring
    ports:
    - protocol: TCP
      port: 8000

---
# Allow monitoring access to all services
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-monitoring-access
  namespace: justnews
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          component: monitoring
    ports:
    - protocol: TCP

---
# Deny all other traffic by default
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
  namespace: justnews
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
  ingress: []
  egress:
  - to:
    - podSelector:
        matchLabels:
          component: database
    ports:
    - protocol: TCP
      port: 5432
    - protocol: TCP
      port: 6379
  - to:
    - podSelector:
        matchLabels:
          app: mcp-bus
    ports:
    - protocol: TCP
      port: 8000
  - to: []  # Allow DNS resolution
    ports:
    - protocol: UDP
      port: 53
  - to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: TCP
      port: 443  # API server
    - protocol: TCP
      port: 6443  # API server

---
# Pod Security Standards
apiVersion: v1
kind: ConfigMap
metadata:
  name: pod-security-standards
  namespace: justnews
data:
  policy.yaml: |
    apiVersion: policy/v1beta1
    kind: PodSecurityPolicy
    metadata:
      name: restricted-psp
    spec:
      privileged: false
      allowPrivilegeEscalation: false
      requiredDropCapabilities:
        - ALL
      volumes:
        - 'configMap'
        - 'emptyDir'
        - 'persistentVolumeClaim'
        - 'secret'
      runAsUser:
        rule: 'MustRunAsNonRoot'
      seLinux:
        rule: 'RunAsAny'
      supplementalGroups:
        rule: 'MustRunAs'
        ranges:
        - min: 1
          max: 65535
      fsGroup:
        rule: 'MustRunAs'
        ranges:
        - min: 1
          max: 65535

---
# Service Account for agents
apiVersion: v1
kind: ServiceAccount
metadata:
  name: justnews-agent-sa
  namespace: justnews
automountServiceAccountToken: false

---
# Role for agent operations
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: agent-role
  namespace: justnews
rules:
- apiGroups: [""]
  resources: ["pods", "services", "configmaps"]
  verbs: ["get", "list", "watch"]
- apiGroups: [""]
  resources: ["events"]
  verbs: ["create", "patch", "update"]

---
# RoleBinding for agents
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: agent-rolebinding
  namespace: justnews
subjects:
- kind: ServiceAccount
  name: justnews-agent-sa
  namespace: justnews
roleRef:
  kind: Role
  name: agent-role
  apiGroup: rbac.authorization.k8s.io