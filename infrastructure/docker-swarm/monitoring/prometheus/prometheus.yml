global:
  scrape_interval: 15s
  evaluation_interval: 15s

rule_files:
  # - "first_rules.yml"
  # - "second_rules.yml"

scrape_configs:
  # The job name is added as a label `job=<job_name>` to any timeseries scraped from this config.
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']

  # Docker Swarm service discovery
  - job_name: 'docker-swarm-services'
    docker_swarm_sd_configs:
      - host: unix:///var/run/docker.sock
        role: services
    relabel_configs:
      - source_labels: [__meta_dockerswarm_service_name]
        regex: (.+)
        target_label: service_name
        replacement: $1
      - source_labels: [__meta_dockerswarm_service_name]
        regex: (.+)
        target_label: job
        replacement: $1
      - source_labels: [__meta_dockerswarm_service_task_container_id]
        regex: (.+)
        target_label: container_id
        replacement: $1
      - source_labels: [__meta_dockerswarm_service_name]
        regex: (.+)
        target_label: __metrics_path__
        replacement: /metrics

  # JustNews specific services
  - job_name: 'justnews-agents'
    docker_swarm_sd_configs:
      - host: unix:///var/run/docker.sock
        role: tasks
    relabel_configs:
      - source_labels: [__meta_dockerswarm_task_slot]
        regex: (.+)
        target_label: slot
        replacement: $1
      - source_labels: [__meta_dockerswarm_service_name]
        regex: (.+)
        target_label: service
        replacement: $1
      - source_labels: [__meta_dockerswarm_task_desired_state]
        regex: (.+)
        target_label: state
        replacement: $1
      - source_labels: [__meta_dockerswarm_service_name]
        regex: 'justnews-(.+)'
        target_label: agent_type
        replacement: $1
      - source_labels: [__meta_dockerswarm_service_name]
        regex: (.+)
        target_label: __metrics_path__
        replacement: /metrics
      - source_labels: [__meta_dockerswarm_service_name]
        regex: (.+)
        target_label: job
        replacement: justnews-agent

  # PostgreSQL metrics
  - job_name: 'postgres'
    static_configs:
      - targets: ['postgres:9187']
    scrape_interval: 10s

  # Redis metrics
  - job_name: 'redis'
    static_configs:
      - targets: ['redis:9121']
    scrape_interval: 10s