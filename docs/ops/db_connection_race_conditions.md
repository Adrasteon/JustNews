# MariaDB "Unread result found" race conditions — diagnosis & fixes

Symptoms --------

- Intermittent ingestion responses with "content_save_error": "Unread result found".

- Reproduced when the memory agent or other agents run concurrent DB operations on a single shared mysql connector object.

Root cause ----------

- The Python mysql-connector driver returns an unbuffered cursor by default and will raise "Unread result found" if a new query is executed against a connection while a previous resultset has not been completely consumed.

- This error is more likely when a single shared connection object is reused concurrently by multiple callers.

Fix applied ----------- Applied changes in this repo:

- Added `MigratedDatabaseService.get_connection()` — a helper to create a fresh MariaDB connection for short-lived / per-request work.

- Updated memory agent save path (agents/memory/tools.py) to use per-request connections when available and to use buffered cursors. This reduces contention and prevents unconsumed resultsets from causing the exception.

- Hardened memory engine cursors to use buffered=true in a few places where unbuffered cursors could lead to the same error.

How to verify (local dev) -------------------------

1. Restart the memory agent process so it reloads the updated code:

```bash

## example: if you run agents with systemd or a local start script, restart the service

sudo systemctl restart justnews-memory-agent || ./scripts/start-memory-agent.sh

```bash

1. Re-run the ingestion diagnostic (200 samples):

```bash
conda run -n justnews-py312 python scripts/ops/diagnose_ingestion_samples.py --sample 200 --post

```

1. Inspect the memory agent logs (logs/ or systemd journal) for any remaining "Unread result found" errors. The expected result is that the number of such entries should significantly reduce or disappear.

Next steps (recommended) ------------------------

- Consider switching to a connection pool for high-throughput components (mysql.connector.pooling.MySQLConnectionPool) if the workload is very concurrent.

- Audit other agents that use `mb_conn`directly and prefer using`get_connection()` or a connection helper/context manager to ensure per-request connections.

- Add runtime health metrics to detect elevated rates of database errors and retry conditions.

--- This note was autogenerated as part of the fix for the ingestion "Unread result found" race condition.
