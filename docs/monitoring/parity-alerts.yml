groups:
  - name: parity_alerts
    rules:
      - alert: ParityMismatchDetected
        expr: >-
          increase(justnews_stage_b_parity_checks_total{result="mismatch"}[5m]) > 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Parity mismatches observed in the last 5m"
          description: "The parity verifier detected one or more mismatches between MariaDB and Chroma in the last 5 minutes. Investigate parity checks and backups under scripts/dev/backups."

      - alert: ParityRepairFailures
        expr: >-
          increase(justnews_stage_b_parity_repair_actions_total{action="failed"}[5m]) > 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Parity repair failures detected"
          description: "Parity repair actions reported failures in the last 5 minutes. Operator attention required."

      - alert: ParityRepairPartialFailures
        expr: >-
          increase(justnews_stage_b_parity_repair_actions_total{action="repair_partial_failure"}[10m]) > 0
        for: 10m
        labels:
          severity: critical
        annotations:
          summary: "Partial parity repair failures"
          description: "A parity repair run completed with partial failures recently. Inspect backups and the repair execution logs."

      - alert: ParityRepairRequired
        expr: >-
          increase(justnews_stage_b_parity_checks_total{result="mismatch"}[30m]) > 0 and
          increase(justnews_stage_b_parity_repair_actions_total{action=~"inserted|updated|deleted|repair_success"}[30m]) == 0
        for: 30m
        labels:
          severity: warning
        annotations:
          summary: "Parity mismatches with no repairs observed"
          description: "Parity verifier detected mismatches in the last 30 minutes but no repair actions were observed. Investigate parity verification logs and backups under scripts/dev/backups."
