#!/usr/bin/env bash
# Pre-push Git hook for JustNews
# - Encourages developers to run tests via the repository pytest wrapper
# - Non-blocking by default; set GIT_STRICT_TEST_HOOK=1 to make it block

set -euo pipefail

BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "(unknown)")

echo "[justnews] pre-push: checking pytest environment and smoke tests (optional)..."
if [[ -z "${CI:-}" ]]; then
  # Locally ensure canonical env is present / active
  if [[ -x ./scripts/dev/ensure_canonical_env.sh ]]; then
    ./scripts/dev/ensure_canonical_env.sh || true
  fi
  echo "[justnews] Notice: we recommend running tests via scripts/dev/pytest.sh inside the '${CANONICAL_ENV:-justnews-py312}' conda env for consistency."
  echo "[justnews] To bypass this message set ALLOW_ANY_PYTEST_ENV=1 or set up the conda env."
fi

if [[ "${GIT_STRICT_TEST_HOOK:-0}" == "1" ]]; then
  echo "[justnews] Running a quick unit smoke test before push..."
  # Run a quick targeted unit test to avoid long push-time
  if command -v ./scripts/dev/pytest.sh >/dev/null 2>&1; then
    ./scripts/dev/pytest.sh -q -k "not integration" -q --maxfail=1
  else
    echo "[justnews] Warning: pytest wrapper not found. Falling back to running pytest directly."
    pytest -q -k "not integration" --maxfail=1
  fi
  RC=$?
  if [ $RC -ne 0 ]; then
    echo "[justnews] Pre-push smoke tests failed; aborting push." >&2
    exit $RC
  fi
fi

echo "[justnews] pre-push checks passed (or skipped). Proceeding with push."
exit 0
