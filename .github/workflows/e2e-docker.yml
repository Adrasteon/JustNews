name: CI â€” E2E Docker (manual)

on:
  workflow_dispatch:
    inputs:
      python_version:
        description: 'Python version to run tests with'
        required: false
        default: '3.12'

jobs:
  e2e-docker:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up qemu
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker buildx
        uses: docker/setup-buildx-action@v2

      - name: Build pre-seeded MariaDB image (with cache)
        uses: docker/build-push-action@v4
        with:
          context: ./scripts/dev
          file: db-mariadb/Dockerfile
          push: false
          tags: justnews/mariadb-preseed:local
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Start docker-compose services
        run: |
          docker-compose -f scripts/dev/docker-compose.e2e.yml up -d

      - name: Wait for DB and Redis
        run: |
          docker-compose -f scripts/dev/docker-compose.e2e.yml ps
          sleep 5

      - name: Run quick smoke checks (redis + mariadb)
        run: |
          chmod +x scripts/dev/e2e_smoke.sh
          scripts/dev/e2e_smoke.sh

      - name: Install Miniconda
        uses: conda-incubator/setup-miniconda@v2
        with:
          python-version: '3.12'
          auto-activate-base: false

      - name: Create / update conda env (justnews-py312)
        run: |
          conda env list
          conda env create -f environment.yml -n justnews-py312 || conda env update -f environment.yml -n justnews-py312 || true

      - name: Install dependencies (conda)
        run: |
          conda run -n justnews-py312 python -m pip install --upgrade pip
          conda run -n justnews-py312 python -m pip install -r requirements.txt || true

      - name: Install Python & deps
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-${{ github.event.inputs.python_version }} python3-pip
          python3 -m pip install -r requirements.txt

      - name: Run representative E2E smoke tests (conda)
        run: |
          conda run -n justnews-py312 pytest -q tests/e2e/test_docker_poc_representative.py -q -s

      - name: Run full E2E tests (conda)
        run: |
          export MARIADB_HOST=127.0.0.1
          export MARIADB_PORT=13306
          export MARIADB_DB=justnews_test
          export MARIADB_USER=justnews
          export MARIADB_PASSWORD=test
          export REDIS_URL=redis://127.0.0.1:16379
          export E2E_REAL=1
          export PYTEST_RUNNING=1
          conda run -n justnews-py312 pytest tests/e2e -q -s

      - name: Tear down
        if: always()
        run: docker-compose -f scripts/dev/docker-compose.e2e.yml down -v
