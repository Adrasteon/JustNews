name: Integration - Chroma + MariaDB

on:
  workflow_dispatch:
  pull_request:
    branches: [ main ]

jobs:
  integration:
    runs-on: ubuntu-latest
    services:
      mariadb:
        image: mariadb:10.6
        ports: ["3306:3306"]
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: justnews_test
        options: >-
          --health-cmd="mysqladmin ping --silent" --health-interval=5s
      chroma:
        image: chromadb/chromadb:0.3.22
        ports: ["3307:3307"]
        options: >-
          --health-cmd="curl -sS http://localhost:3307/" --health-interval=5s
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      - name: Install requirements
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Wait for services (bounded)
        run: |
          echo "Waiting for MariaDB..."
          ATTEMPTS=60
          i=0
          until mysqladmin ping -h 127.0.0.1 -P 3306 --silent; do
            i=$((i+1))
            if [ "$i" -ge "$ATTEMPTS" ]; then
              echo "MariaDB did not become ready after ${ATTEMPTS}s" >&2
              exit 1
            fi
            sleep 1
          done
          echo "Waiting for Chroma..."
          ATTEMPTS=60
          i=0
          until curl -sS http://127.0.0.1:3307/ | grep -q "Chroma"; do
            i=$((i+1))
            if [ "$i" -ge "$ATTEMPTS" ]; then
              echo "Chroma did not become ready after ${ATTEMPTS}s" >&2
              exit 1
            fi
            sleep 1
          done
      - name: Run integration tests
        run: |
          pytest tests/agents/memory/test_save_article.py::test_save_article_chroma_required -q
