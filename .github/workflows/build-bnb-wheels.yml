name: Build bitsandbytes wheels

on:
  workflow_dispatch:
  schedule:
    # weekly rebuild / smoke test on self-hosted GPU runners
    - cron: '0 3 * * 0'

jobs:
  build-wheels:
    name: Build wheels for multiple CUDA targets
    # NOTE: This workflow expects a self-hosted runner with GPUs (or a runner capable of nvidia-docker).
    runs-on: [self-hosted, linux, gpu]
    strategy:
      matrix:
        cuda_short: [122, 124, 128]

    steps:
      - uses: actions/checkout@v4

      - name: Show runner info
        run: |
          uname -a
          nvidia-smi || true

      - name: Ensure workspace permissions
        run: chmod -R a+rw . || true

      - name: Build bitsandbytes wheel (docker if available)
        env:
          BNB_DOCKER: 1
        run: |
          set -euo pipefail
          echo "Building for CUDA short: ${{ matrix.cuda_short }}"
          ./.build/bitsandbytes/build_wheels.sh ${{ matrix.cuda_short }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bitsandbytes-wheel-${{ matrix.cuda_short }}
          path: .build/bitsandbytes/dist/*.whl
